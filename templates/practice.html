<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #21262d;
            --bg-elevated: #30363d;
            --accent: #58a6ff;
            --accent-secondary: #238636;
            --accent-warning: #d29922;
            --accent-error: #f85149;
            --accent-purple: #a371f7;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --border: #30363d;
            --border-light: #21262d;
            --success: #3fb950;
            --success-bg: rgba(63, 185, 80, 0.15);
            --error: #f85149;
            --error-bg: rgba(248, 81, 73, 0.15);
            --glow: rgba(88, 166, 255, 0.4);
        }

        [data-theme="light"] {
            --bg-primary: #f6f8fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-elevated: #f6f8fa;
            --accent: #0969da;
            --accent-secondary: #1a7f37;
            --accent-warning: #9a6700;
            --accent-error: #cf222e;
            --accent-purple: #8250df;
            --text-primary: #1f2328;
            --text-secondary: #656d76;
            --text-muted: #8c959f;
            --border: #d0d7de;
            --border-light: #d8dee4;
            --success: #1a7f37;
            --success-bg: rgba(26, 127, 55, 0.1);
            --error: #cf222e;
            --error-bg: rgba(207, 34, 46, 0.1);
            --glow: rgba(9, 105, 218, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', 'Noto Sans SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Navigation */
        .top-nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .nav-brand svg {
            width: 28px;
            height: 28px;
            color: var(--accent);
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-links a, .nav-links button {
            padding: 0.5rem 0.875rem;
            border-radius: 6px;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .nav-links a:hover, .nav-links button:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .nav-links a.active {
            color: var(--accent);
            background: var(--bg-elevated);
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: var(--bg-elevated);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .premium-badge {
            background: linear-gradient(135deg, var(--accent-warning), #f0b429);
            color: #000;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            min-height: calc(100vh - 57px);
            max-width: 1600px;
            margin: 0 auto;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .sidebar, .stats-panel {
                display: none;
            }
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .category-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .category-item:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .category-item.active {
            background: var(--accent);
            color: white;
        }

        .category-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .category-count {
            margin-left: auto;
            font-size: 0.75rem;
            background: var(--bg-elevated);
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            color: var(--text-muted);
        }

        .category-item.active .category-count {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .difficulty-filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .diff-btn {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .diff-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .diff-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .diff-btn.easy { --btn-color: var(--success); }
        .diff-btn.medium { --btn-color: var(--accent-warning); }
        .diff-btn.hard { --btn-color: var(--error); }

        .diff-btn.easy.active { background: var(--success); border-color: var(--success); }
        .diff-btn.medium.active { background: var(--accent-warning); border-color: var(--accent-warning); }
        .diff-btn.hard.active { background: var(--error); border-color: var(--error); }

        /* Practice Area */
        .practice-area {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .practice-header {
            text-align: center;
            margin-bottom: 2rem;
            width: 100%;
            max-width: 700px;
        }

        .practice-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .practice-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Flashcard */
        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            max-width: 600px;
            margin-bottom: 1.5rem;
        }

        .flashcard {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2.5rem;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .flashcard:hover {
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        .card-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .badge {
            padding: 0.25rem 0.625rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-category {
            background: var(--accent);
            color: white;
        }

        .badge-difficulty {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .badge-difficulty.easy { background: var(--success-bg); color: var(--success); }
        .badge-difficulty.medium { background: rgba(210, 153, 34, 0.15); color: var(--accent-warning); }
        .badge-difficulty.hard { background: var(--error-bg); color: var(--error); }

        .card-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .card-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .card-action-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .card-action-btn.bookmarked {
            background: var(--accent-warning);
            border-color: var(--accent-warning);
            color: white;
        }

        .chinese-text {
            font-size: 1.75rem;
            font-weight: 500;
            text-align: center;
            margin-bottom: 1.5rem;
            line-height: 1.5;
            font-family: 'Noto Sans SC', sans-serif;
        }

        .hint-section {
            background: var(--bg-elevated);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .hint-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .hint-text {
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-style: italic;
        }

        /* Answer Input */
        .answer-section {
            width: 100%;
            max-width: 600px;
            margin-bottom: 1.5rem;
        }

        .answer-input-wrapper {
            position: relative;
        }

        .answer-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1.1rem;
            font-family: 'Space Mono', monospace;
            transition: all 0.2s;
            outline: none;
        }

        .answer-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--glow);
        }

        .answer-input.correct {
            border-color: var(--success);
            background: var(--success-bg);
        }

        .answer-input.incorrect {
            border-color: var(--error);
            background: var(--error-bg);
        }

        .answer-input::placeholder {
            color: var(--text-muted);
            font-family: 'DM Sans', sans-serif;
        }

        /* Control Buttons */
        .control-buttons {
            display: flex;
            gap: 1rem;
            width: 100%;
            max-width: 600px;
            margin-bottom: 2rem;
        }

        .btn {
            flex: 1;
            padding: 0.875rem 1.5rem;
            border-radius: 10px;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            border-color: var(--accent);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-skip {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-skip:hover {
            background: var(--bg-elevated);
        }

        /* Answer Reveal */
        .answer-reveal {
            width: 100%;
            max-width: 600px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .answer-reveal.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .answer-reveal-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .answer-reveal-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .answer-reveal-icon.correct {
            background: var(--success-bg);
            color: var(--success);
        }

        .answer-reveal-icon.incorrect {
            background: var(--error-bg);
            color: var(--error);
        }

        .answer-reveal-title {
            font-weight: 600;
        }

        .answer-reveal-title.correct { color: var(--success); }
        .answer-reveal-title.incorrect { color: var(--error); }

        .reference-answer {
            background: var(--bg-elevated);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .your-answer {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .your-answer span {
            font-family: 'Space Mono', monospace;
            color: var(--text-primary);
        }

        /* Progress Bar */
        .progress-section {
            width: 100%;
            max-width: 600px;
            margin-bottom: 1.5rem;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-purple));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Stats Panel */
        .stats-panel {
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .stats-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .stats-card-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .streak-display {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .streak-number {
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent-warning);
            font-family: 'Space Mono', monospace;
            line-height: 1;
        }

        .streak-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .streak-label strong {
            color: var(--text-primary);
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.75rem;
            background: var(--bg-elevated);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            font-family: 'Space Mono', monospace;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* History List */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-elevated);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .history-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .history-icon.mastered {
            background: var(--success-bg);
            color: var(--success);
        }

        .history-icon.learning {
            background: rgba(88, 166, 255, 0.15);
            color: var(--accent);
        }

        .history-icon.new {
            background: var(--bg-card);
            color: var(--text-muted);
        }

        .history-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-secondary);
        }

        .history-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Daily Limit Warning */
        .limit-warning {
            background: var(--error-bg);
            border: 1px solid var(--error);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .limit-warning-icon {
            font-size: 1.25rem;
        }

        .limit-warning-text {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .limit-warning a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }

        .limit-warning a:hover {
            text-decoration: underline;
        }

        /* Mastery Indicator */
        .mastery-indicator {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .mastery-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-elevated);
        }

        .mastery-dot.filled {
            background: var(--success);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        /* Theme Toggle */
        .theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Keyboard Shortcuts */
        .shortcuts-hint {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .shortcut {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        kbd {
            padding: 0.2rem 0.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .practice-area {
                padding: 1rem;
            }
            .flashcard {
                padding: 1.5rem;
                min-height: 220px;
            }
            .chinese-text {
                font-size: 1.35rem;
            }
            .control-buttons {
                flex-direction: column;
            }
            .shortcuts-hint {
                display: none;
            }
        }

        /* Loading spinner */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--error);
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <a href="/" class="nav-brand">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
            </svg>
            SpeakFlow
        </a>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/practice" class="active">Practice</a>
            <a href="/community">Community</a>
            <a href="/pricing">Pricing</a>
            {% if user %}
                <div class="user-badge">
                    {% if user.is_premium %}
                        <span class="premium-badge">PRO</span>
                    {% endif %}
                    <span>{{ user.username }}</span>
                </div>
                <a href="/logout">Logout</a>
            {% else %}
                <a href="/login">Login</a>
            {% endif %}
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
            </button>
        </div>
    </nav>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">Categories</h3>
                <div class="category-list" id="categoryList">
                    <div class="category-item active" data-category="all">
                        <span class="category-icon">üìö</span>
                        <span>All Sentences</span>
                        <span class="category-count" id="count-all">0</span>
                    </div>
                    <div class="category-item" data-category="daily">
                        <span class="category-icon">üè†</span>
                        <span>Daily Life</span>
                        <span class="category-count" id="count-daily">0</span>
                    </div>
                    <div class="category-item" data-category="weather">
                        <span class="category-icon">üå§Ô∏è</span>
                        <span>Weather</span>
                        <span class="category-count" id="count-weather">0</span>
                    </div>
                    <div class="category-item" data-category="travel">
                        <span class="category-icon">‚úàÔ∏è</span>
                        <span>Travel</span>
                        <span class="category-count" id="count-travel">0</span>
                    </div>
                    <div class="category-item" data-category="business">
                        <span class="category-icon">üíº</span>
                        <span>Business</span>
                        <span class="category-count" id="count-business">0</span>
                    </div>
                    <div class="category-item" data-category="social">
                        <span class="category-icon">üëã</span>
                        <span>Social</span>
                        <span class="category-count" id="count-social">0</span>
                    </div>
                    <div class="category-item" data-category="bookmarked">
                        <span class="category-icon">‚≠ê</span>
                        <span>Bookmarked</span>
                        <span class="category-count" id="count-bookmarked">0</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-title">Difficulty</h3>
                <div class="difficulty-filters">
                    <button class="diff-btn active" data-difficulty="all">All</button>
                    <button class="diff-btn easy" data-difficulty="1">Easy</button>
                    <button class="diff-btn medium" data-difficulty="2">Medium</button>
                    <button class="diff-btn hard" data-difficulty="3">Hard</button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-title">Practice Mode</h3>
                <div class="category-list">
                    <div class="category-item active" data-mode="new">
                        <span class="category-icon">üÜï</span>
                        <span>New Sentences</span>
                    </div>
                    <div class="category-item" data-mode="review">
                        <span class="category-icon">üîÑ</span>
                        <span>Review</span>
                    </div>
                    <div class="category-item" data-mode="weak">
                        <span class="category-icon">üí™</span>
                        <span>Weak Points</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Practice Area -->
        <main class="practice-area">
            <div class="practice-header">
                <h1 class="practice-title">English Speaking Practice</h1>
                <p class="practice-subtitle">Translate the Chinese sentence into English</p>
            </div>

            <!-- Daily Limit Warning (for free users) -->
            <div class="limit-warning" id="limitWarning" style="display: none;">
                <span class="limit-warning-icon">‚ö†Ô∏è</span>
                <div class="limit-warning-text">
                    You've reached your daily limit of <strong id="limitCount">10</strong> sentences.
                    <a href="/pricing">Upgrade to Premium</a> for unlimited practice!
                </div>
            </div>

            <!-- Progress -->
            <div class="progress-section">
                <div class="progress-info">
                    <span>Today's Progress</span>
                    <span><span id="practiceCount">0</span> / <span id="dailyLimit">10</span> sentences</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Flashcard -->
            <div class="flashcard-container">
                <div class="flashcard" id="flashcard">
                    <div class="card-badge">
                        <span class="badge badge-category" id="cardCategory">Daily</span>
                        <span class="badge badge-difficulty easy" id="cardDifficulty">Easy</span>
                    </div>
                    <div class="card-actions">
                        <button class="card-action-btn" id="bookmarkBtn" title="Bookmark">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                            </svg>
                        </button>
                        <button class="card-action-btn" id="speakBtn" title="Listen">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                            </svg>
                        </button>
                    </div>
                    <div class="chinese-text" id="chineseText">Loading...</div>
                    <div class="hint-section" id="hintSection">
                        <div class="hint-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            Hint
                        </div>
                        <div class="hint-text" id="hintText">-</div>
                    </div>
                    <div class="mastery-indicator" id="masteryIndicator">
                        <div class="mastery-dot"></div>
                        <div class="mastery-dot"></div>
                        <div class="mastery-dot"></div>
                        <div class="mastery-dot"></div>
                        <div class="mastery-dot"></div>
                    </div>
                </div>
            </div>

            <!-- Answer Input -->
            <div class="answer-section">
                <div class="answer-input-wrapper">
                    <input 
                        type="text" 
                        class="answer-input" 
                        id="answerInput" 
                        placeholder="Type your English translation here..."
                        autocomplete="off"
                    >
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="control-buttons">
                <button class="btn btn-skip" id="skipBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 4 15 12 5 20 5 4"/>
                        <line x1="19" y1="5" x2="19" y2="19"/>
                    </svg>
                    Skip
                </button>
                <button class="btn btn-secondary" id="showAnswerBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Show Answer
                </button>
                <button class="btn btn-primary" id="checkBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Check
                </button>
            </div>

            <!-- Answer Reveal -->
            <div class="answer-reveal" id="answerReveal">
                <div class="answer-reveal-header">
                    <div class="answer-reveal-icon" id="revealIcon">‚úì</div>
                    <div class="answer-reveal-title" id="revealTitle">Correct!</div>
                </div>
                <div class="reference-answer" id="referenceAnswer">-</div>
                <div class="your-answer" id="yourAnswerSection">
                    Your answer: <span id="yourAnswer">-</span>
                </div>
                <div class="control-buttons" style="margin-top: 1rem; margin-bottom: 0;">
                    <button class="btn btn-success" id="nextBtn">
                        Next Sentence
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"/>
                            <polyline points="12 5 19 12 12 19"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Keyboard Shortcuts -->
            <div class="shortcuts-hint">
                <div class="shortcut"><kbd>Enter</kbd> Check/Next</div>
                <div class="shortcut"><kbd>Ctrl+H</kbd> Show hint</div>
                <div class="shortcut"><kbd>Ctrl+S</kbd> Skip</div>
            </div>
        </main>

        <!-- Stats Panel -->
        <aside class="stats-panel">
            <div class="stats-card">
                <h3 class="stats-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    Current Streak
                </h3>
                <div class="streak-display">
                    <span class="streak-number" id="currentStreak">0</span>
                    <div class="streak-label">
                        <strong>days</strong>
                        in a row
                    </div>
                </div>
            </div>

            <div class="stats-card">
                <h3 class="stats-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    Statistics
                </h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalPracticed">0</div>
                        <div class="stat-label">Total Practiced</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="masteredCount">0</div>
                        <div class="stat-label">Mastered</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="longestStreak">0</div>
                        <div class="stat-label">Best Streak</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalDays">0</div>
                        <div class="stat-label">Days Active</div>
                    </div>
                </div>
            </div>

            <div class="stats-card">
                <h3 class="stats-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Recent Activity
                </h3>
                <div class="history-list" id="historyList">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // State
        let sentences = [];
        let currentSentence = null;
        let currentIndex = 0;
        let practiceHistory = [];
        let userStats = {
            currentStreak: 0,
            longestStreak: 0,
            totalPracticed: 0,
            totalDays: 0,
            masteredCount: 0,
            dailyCount: 0,
            dailyLimit: {{ user.tier_limits if user else 10 }}
        };
        let filters = {
            category: 'all',
            difficulty: 'all',
            mode: 'new'
        };
        let isAnswerRevealed = false;
        let isPremium = {{ 'true' if user and user.is_premium else 'false' }};
        let isLoggedIn = {{ 'true' if user else 'false' }};

        // Initialize with server-side sentences as fallback
        sentences = {{ sentences | tojson | safe }};

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initTheme();
            
            // If no sentences from server, try API
            if (!sentences || sentences.length === 0) {
                await loadSentences();
            } else {
                updateCategoryCounts();
            }
            
            // Load user-specific data
            if (isLoggedIn) {
                await loadUserStats();
                await loadHistory();
            } else {
                // Show login message for history
                document.getElementById('historyList').innerHTML = `
                    <div class="empty-state">
                        <p>Login to track your progress</p>
                    </div>
                `;
            }
            
            setupEventListeners();
            showNextSentence();
        });

        // Theme
        function initTheme() {
            const saved = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        // Load sentences from API (fallback)
        async function loadSentences() {
            try {
                const response = await fetch('/api/sentences');
                if (response.ok) {
                    sentences = await response.json();
                    updateCategoryCounts();
                } else {
                    console.error('Failed to load sentences:', response.status);
                    document.getElementById('chineseText').textContent = 'Failed to load sentences';
                }
            } catch (error) {
                console.error('Failed to load sentences:', error);
                document.getElementById('chineseText').textContent = 'Failed to load sentences';
            }
        }

        // Load user stats
        async function loadUserStats() {
            if (!isLoggedIn) return;
            
            try {
                const response = await fetch('/api/practice/stats');
                if (response.ok) {
                    const data = await response.json();
                    userStats = {
                        ...userStats,
                        currentStreak: data.current_streak || 0,
                        longestStreak: data.longest_streak || 0,
                        totalPracticed: data.total_sentences_practiced || 0,
                        totalDays: data.total_practice_days || 0,
                        masteredCount: data.mastered_count || 0,
                        dailyCount: data.today_count || 0,
                        dailyLimit: data.daily_limit || 10
                    };
                    updateStatsDisplay();
                    checkDailyLimit();
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load practice history
        async function loadHistory() {
            if (!isLoggedIn) {
                document.getElementById('historyList').innerHTML = `
                    <div class="empty-state">
                        <p>Login to track your progress</p>
                    </div>
                `;
                return;
            }
            
            try {
                const response = await fetch('/api/practice/history?limit=10');
                if (response.ok) {
                    practiceHistory = await response.json();
                    renderHistory();
                } else {
                    document.getElementById('historyList').innerHTML = `
                        <div class="empty-state">
                            <p>No practice history yet</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load history:', error);
                document.getElementById('historyList').innerHTML = `
                    <div class="empty-state">
                        <p>Failed to load history</p>
                    </div>
                `;
            }
        }

        // Update category counts
        function updateCategoryCounts() {
            const counts = { all: sentences.length };
            sentences.forEach(s => {
                const cat = s.category || 'general';
                counts[cat] = (counts[cat] || 0) + 1;
            });
            
            Object.keys(counts).forEach(cat => {
                const el = document.getElementById(`count-${cat}`);
                if (el) el.textContent = counts[cat];
            });
        }

        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('currentStreak').textContent = userStats.currentStreak;
            document.getElementById('longestStreak').textContent = userStats.longestStreak;
            document.getElementById('totalPracticed').textContent = userStats.totalPracticed;
            document.getElementById('totalDays').textContent = userStats.totalDays;
            document.getElementById('masteredCount').textContent = userStats.masteredCount;
            document.getElementById('practiceCount').textContent = userStats.dailyCount;
            document.getElementById('dailyLimit').textContent = isPremium ? '‚àû' : userStats.dailyLimit;
            
            // Update progress bar
            const progress = isPremium ? 50 : Math.min((userStats.dailyCount / userStats.dailyLimit) * 100, 100);
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        // Check daily limit
        function checkDailyLimit() {
            if (!isPremium && userStats.dailyCount >= userStats.dailyLimit) {
                document.getElementById('limitWarning').style.display = 'flex';
                document.getElementById('limitCount').textContent = userStats.dailyLimit;
                document.getElementById('answerInput').disabled = true;
                document.getElementById('checkBtn').disabled = true;
            }
        }

        // Render history
        function renderHistory() {
            const container = document.getElementById('historyList');
            
            if (practiceHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No practice history yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = practiceHistory.map(item => {
                const iconClass = item.is_mastered ? 'mastered' : (item.mastery_level > 0 ? 'learning' : 'new');
                const icon = item.is_mastered ? '‚úì' : (item.mastery_level > 0 ? '‚óê' : '‚óã');
                const timeAgo = getTimeAgo(item.updated_at);
                
                return `
                    <div class="history-item">
                        <div class="history-icon ${iconClass}">${icon}</div>
                        <div class="history-text">${item.chinese || 'Unknown'}</div>
                        <div class="history-time">${timeAgo}</div>
                    </div>
                `;
            }).join('');
        }

        // Get filtered sentences
        function getFilteredSentences() {
            return sentences.filter(s => {
                if (filters.category !== 'all' && filters.category !== 'bookmarked') {
                    if (s.category !== filters.category) return false;
                }
                if (filters.difficulty !== 'all') {
                    if (s.difficulty !== parseInt(filters.difficulty)) return false;
                }
                return true;
            });
        }

        // Show next sentence
        function showNextSentence() {
            const filtered = getFilteredSentences();
            
            if (filtered.length === 0) {
                document.getElementById('chineseText').textContent = 'No sentences available';
                document.getElementById('hintText').textContent = 'Try selecting a different category';
                return;
            }
            
            // Get random sentence
            currentIndex = Math.floor(Math.random() * filtered.length);
            currentSentence = filtered[currentIndex];
            
            // Update display
            document.getElementById('chineseText').textContent = currentSentence.chinese;
            document.getElementById('hintText').textContent = currentSentence.hint || 'No hint available';
            document.getElementById('cardCategory').textContent = capitalizeFirst(currentSentence.category || 'General');
            
            // Update difficulty badge
            const diffBadge = document.getElementById('cardDifficulty');
            const diffMap = { 1: 'Easy', 2: 'Medium', 3: 'Hard' };
            const diffClass = { 1: 'easy', 2: 'medium', 3: 'hard' };
            diffBadge.textContent = diffMap[currentSentence.difficulty] || 'Easy';
            diffBadge.className = `badge badge-difficulty ${diffClass[currentSentence.difficulty] || 'easy'}`;
            
            // Update mastery indicator
            updateMasteryIndicator(currentSentence.mastery_level || 0);
            
            // Reset state
            isAnswerRevealed = false;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').className = 'answer-input';
            document.getElementById('answerReveal').classList.remove('show');
            document.getElementById('answerInput').focus();
        }

        // Update mastery indicator
        function updateMasteryIndicator(level) {
            const dots = document.querySelectorAll('.mastery-dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('filled', i < level);
            });
        }

        // Check answer
        async function checkAnswer() {
            if (!currentSentence || isAnswerRevealed) {
                if (isAnswerRevealed) {
                    showNextSentence();
                }
                return;
            }
            
            const userAnswer = document.getElementById('answerInput').value.trim();
            
            if (!userAnswer) {
                showToast('Please enter your answer', 'error');
                return;
            }
            
            // Check daily limit
            if (!isPremium && userStats.dailyCount >= userStats.dailyLimit) {
                showToast('Daily limit reached! Upgrade to continue.', 'error');
                return;
            }
            
            // Simple comparison (could be improved with fuzzy matching)
            const reference = currentSentence.english || '';
            const isCorrect = compareAnswers(userAnswer, reference);
            
            // Show result
            showAnswerReveal(userAnswer, reference, isCorrect);
            
            // Record practice
            if (isLoggedIn) {
                await recordPractice(currentSentence.id, userAnswer, isCorrect);
            }
        }

        // Compare answers (basic fuzzy matching)
        function compareAnswers(user, reference) {
            const normalize = (s) => s.toLowerCase()
                .replace(/[.,!?;:'"]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
            
            const userNorm = normalize(user);
            const refNorm = normalize(reference);
            
            // Exact match
            if (userNorm === refNorm) return true;
            
            // Check if most words match
            const userWords = userNorm.split(' ');
            const refWords = refNorm.split(' ');
            
            let matches = 0;
            userWords.forEach(w => {
                if (refWords.includes(w)) matches++;
            });
            
            return matches / Math.max(userWords.length, refWords.length) > 0.7;
        }

        // Show answer reveal
        function showAnswerReveal(userAnswer, reference, isCorrect) {
            isAnswerRevealed = true;
            
            const input = document.getElementById('answerInput');
            input.className = `answer-input ${isCorrect ? 'correct' : 'incorrect'}`;
            
            const reveal = document.getElementById('answerReveal');
            const icon = document.getElementById('revealIcon');
            const title = document.getElementById('revealTitle');
            
            icon.textContent = isCorrect ? '‚úì' : '‚úó';
            icon.className = `answer-reveal-icon ${isCorrect ? 'correct' : 'incorrect'}`;
            title.textContent = isCorrect ? 'Correct!' : 'Not quite right';
            title.className = `answer-reveal-title ${isCorrect ? 'correct' : 'incorrect'}`;
            
            document.getElementById('referenceAnswer').textContent = reference || 'No reference answer available';
            document.getElementById('yourAnswer').textContent = userAnswer;
            
            reveal.classList.add('show');
        }

        // Show answer without checking
        function showAnswer() {
            if (!currentSentence || isAnswerRevealed) return;
            
            const userAnswer = document.getElementById('answerInput').value.trim() || '(no answer)';
            showAnswerReveal(userAnswer, currentSentence.english || '', false);
        }

        // Record practice
        async function recordPractice(sentenceId, userAnswer, isCorrect) {
            try {
                const response = await fetch('/api/practice/record', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sentence_id: sentenceId,
                        user_answer: userAnswer,
                        is_correct: isCorrect
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userStats.dailyCount = data.today_count || userStats.dailyCount + 1;
                    userStats.totalPracticed = data.total_practiced || userStats.totalPracticed + 1;
                    updateStatsDisplay();
                    checkDailyLimit();
                    
                    // Reload history
                    loadHistory();
                } else if (response.status === 429) {
                    showToast('Daily limit reached!', 'error');
                    checkDailyLimit();
                }
            } catch (error) {
                console.error('Failed to record practice:', error);
            }
        }

        // Skip sentence
        function skipSentence() {
            showNextSentence();
        }

        // Toggle bookmark
        function toggleBookmark() {
            const btn = document.getElementById('bookmarkBtn');
            btn.classList.toggle('bookmarked');
            
            if (btn.classList.contains('bookmarked')) {
                showToast('Bookmarked!', 'success');
            }
        }

        // Speak text
        function speakText() {
            if (!currentSentence?.english) return;
            
            const utterance = new SpeechSynthesisUtterance(currentSentence.english);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Check button
            document.getElementById('checkBtn').addEventListener('click', checkAnswer);
            
            // Show answer button
            document.getElementById('showAnswerBtn').addEventListener('click', showAnswer);
            
            // Skip button
            document.getElementById('skipBtn').addEventListener('click', skipSentence);
            
            // Next button
            document.getElementById('nextBtn').addEventListener('click', showNextSentence);
            
            // Bookmark button
            document.getElementById('bookmarkBtn').addEventListener('click', toggleBookmark);
            
            // Speak button
            document.getElementById('speakBtn').addEventListener('click', speakText);
            
            // Enter key to check/next
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    if (isAnswerRevealed) {
                        showNextSentence();
                    } else {
                        checkAnswer();
                    }
                }
            });
            
            // Category filters
            document.querySelectorAll('.category-item[data-category]').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.category-item[data-category]').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    filters.category = item.dataset.category;
                    showNextSentence();
                });
            });
            
            // Difficulty filters
            document.querySelectorAll('.diff-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    filters.difficulty = btn.dataset.difficulty;
                    showNextSentence();
                });
            });
            
            // Mode filters
            document.querySelectorAll('.category-item[data-mode]').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.category-item[data-mode]').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    filters.mode = item.dataset.mode;
                    showNextSentence();
                });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    skipSentence();
                }
                if (e.ctrlKey && e.key === 'h') {
                    e.preventDefault();
                    document.getElementById('hintSection').scrollIntoView({ behavior: 'smooth' });
                }
            });
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Utility functions
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function getTimeAgo(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }
    </script>
</body>
</html>
